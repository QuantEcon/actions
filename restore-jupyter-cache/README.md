# Restore Jupyter Cache Action

Restores Jupyter Book build cache from GitHub Actions cache. Designed for PR workflows that need to restore cache generated by main branch builds.

## Design Philosophy

This action is **read-only** - it only restores cache, never saves. This ensures:

- **Single source of truth**: Cache is always from main branch
- **No conflicts**: Multiple PRs don't overwrite each other's cache
- **Predictable state**: You always know where cache came from

For cache generation, use the `build-jupyter-cache` action in your cache.yml workflow.

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `cache-type` | `build` (full `_build`) or `execution` (`.jupyter_cache` only) | No | `build` |
| `path` | Path to restore cache to | No | `_build` |
| `source-dir` | Source directory for lectures (used for content hash in execution cache) | No | `lectures` |
| `environment` | Path to environment file (used for cache key hash) | No | `environment.yml` |
| `environment-update` | Path to delta environment file for container builds (used for cache key hash) | No | `''` |
| `key` | Custom cache key (auto-generated if not specified) | No | Auto |
| `fail-on-miss` | Fail workflow if no cache found | No | `false` |

## Outputs

| Output | Description |
|--------|-------------|
| `cache-hit` | `true` if cache was restored |
| `cache-key` | The cache key that was matched |

## Cache Key Strategy

The action uses **prefix matching** to find the most recently saved cache:

**Build cache** (default):
- Saves as: `build-{env-hash}-{run-id}`
- Restores using prefix: `build-{env-hash}-` → finds most recent

**Execution cache**:
- Saves as: `jupyter-cache-{content-hash}-{run-id}`  
- Restores using prefix: `jupyter-cache-{content-hash}-` → finds most recent

This ensures PRs always get the latest successful cache without conflicts.

## Cache Types

### Build Cache (`cache-type: build`) - Default

Restores entire `_build` directory including HTML, PDF, notebook outputs, and .jupyter_cache.

**Best for**: Fast PR previews with full incremental builds

### Execution Cache (`cache-type: execution`)

Restores only `.jupyter_cache` directory containing cached notebook execution outputs.

**Best for**: Lighter cache when you only need notebook execution state

## Usage

### Basic Usage (Build Cache)

```yaml
- uses: quantecon/actions/restore-jupyter-cache@v1

- uses: quantecon/actions/build-lectures@v1
```

### Execution Cache Only

```yaml
- uses: quantecon/actions/restore-jupyter-cache@v1
  with:
    cache-type: 'execution'
```

### Multi-Builder Workflow

```yaml
# Restore once at start
- uses: quantecon/actions/restore-jupyter-cache@v1

# All builds share restored state
- uses: quantecon/actions/build-lectures@v1
  with:
    builder: 'jupyter'

- uses: quantecon/actions/build-lectures@v1
  with:
    builder: 'pdflatex'

- uses: quantecon/actions/build-lectures@v1
  with:
    builder: 'html'
    html-copy-pdf: true
    html-copy-notebooks: true
```

### Require Cache (Fail if Missing)

```yaml
- uses: quantecon/actions/restore-jupyter-cache@v1
  with:
    fail-on-miss: true
```

## Cache Status Report

The action outputs detailed cache status for debugging:

```
╔════════════════════════════════════════════════════════════════╗
║                    BUILD CACHE STATUS                          ║
╚════════════════════════════════════════════════════════════════╝

  Cache Type:     build
  Requested Key:  build-abc123
  Cache Hit:      true
  Matched Key:    build-abc123

════════════════════════════════════════════════════════════════════
  ✅ Cache restored successfully
════════════════════════════════════════════════════════════════════

Path: _build
Total Size: 156M
Files: 1247
Directories: 89

── Age Information ──
Newest file: index.html
  Modified: 2026-02-04 15:30:00
Oldest file: _config.yml
  Modified: 2026-02-01 09:00:00

── Build Directories ──
  html/: 120M (1100 files)
  latex/: 30M (45 files)
  .jupyter_cache/: 6M
```

## Setting Up Cache Generation

See [templates/cache.yml](../templates/cache.yml) for a complete cache generation workflow.

The cache generation workflow should:
1. Run on main branch (schedule + push)
2. Build from scratch (no cache restore)
3. Save cache using `actions/cache/save`

## Troubleshooting

### Cache Miss on PR

**Symptom**: PR builds show "No cache found"

**Solutions**:
1. Ensure cache.yml workflow has run on main
2. Check if `environment.yml` changed (invalidates build cache)
3. Run cache workflow manually: `gh workflow run cache.yml`

### Stale Cache

**Symptom**: Build uses old outputs

**Solutions**:
1. Clear cache: `gh cache delete "build-*" --repo your-org/repo`
2. Re-run cache generation workflow
3. Verify cache key matches

### Cache Too Large

**Symptom**: Cache restore is slow or fails

**Solutions**:
1. Use `execution` cache type (smaller, ~6 MB vs ~150 MB)
2. Clean build artifacts before saving cache
3. Check GitHub cache storage limits (10 GB per repo)
