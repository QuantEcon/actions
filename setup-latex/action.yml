name: 'Setup LaTeX'
description: 'Installs LaTeX packages required for Jupyter Book PDF builds with global caching shared across all workflows'
author: 'QuantEcon'

inputs:
  cache-version:
    description: 'Cache version for manual invalidation'
    required: false
    default: 'v1'
  latex-requirements-file:
    description: 'Path to latex-requirements.txt file listing packages to install'
    required: false
    default: 'latex-requirements.txt'
  packages:
    description: 'DEPRECATED: Use latex-requirements-file instead. Space-separated list of LaTeX packages (used as fallback)'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Cache LaTeX packages
      uses: actions/cache@v4
      id: latex-cache
      with:
        path: |
          /usr/share/texlive
          /usr/share/texmf
          /var/lib/texmf
        key: latex-${{ runner.os }}-${{ hashFiles(inputs.latex-requirements-file) }}-${{ inputs.cache-version }}
        restore-keys: |
          latex-${{ runner.os }}-${{ hashFiles(inputs.latex-requirements-file) }}-
          latex-${{ runner.os }}-

    - name: Install LaTeX packages
      if: steps.latex-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        # Read packages from latex-requirements.txt (if it exists)
        if [ -f "${{ inputs.latex-requirements-file }}" ]; then
          echo "Reading packages from ${{ inputs.latex-requirements-file }}"
          # Remove comments and empty lines, join with spaces
          PACKAGES=$(grep -v '^#' "${{ inputs.latex-requirements-file }}" | grep -v '^[[:space:]]*$' | tr '\n' ' ')
          echo "Installing LaTeX packages: $PACKAGES"
          sudo apt-get update
          sudo apt-get install -y $PACKAGES
        elif [ -n "${{ inputs.packages }}" ]; then
          echo "Using deprecated packages input (migrate to latex-requirements.txt)"
          echo "Installing LaTeX packages: ${{ inputs.packages }}"
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.packages }}
        else
          echo "Error: No packages specified. Provide either latex-requirements-file or packages input."
          exit 1
        fi
        
    - name: Display LaTeX Info
      shell: bash
      run: |
        echo "::group::LaTeX version"
        latex --version || echo "LaTeX not in PATH"
        pdflatex --version || echo "pdfLaTeX not in PATH"
        xelatex --version || echo "XeLaTeX not in PATH"
        echo "::endgroup::"
        echo "::group::Cache status"
        echo "LaTeX cache hit: ${{ steps.latex-cache.outputs.cache-hit }}"
        if [ "${{ steps.latex-cache.outputs.cache-hit }}" == "true" ]; then
          echo "✅ Restored from cache (saved ~2-3 minutes)"
        else
          echo "❌ Cache miss - installed fresh (took 2-3 minutes)"
        fi
        echo "::endgroup::"

branding:
  icon: 'file-text'
  color: 'green'
