name: Test HTML Builder (Execute Notebooks)

on:
  workflow_run:
    workflows: ["Build QuantEcon Containers"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test-html:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        container: [quantecon, quantecon-build]
        repo:
          - repo: lecture-python-intro
            owner: QuantEcon
          - repo: lecture-python.myst
            owner: QuantEcon
          - repo: lecture-python-advanced.myst
            owner: QuantEcon
          - repo: lecture-jax
            owner: QuantEcon
    
    container:
      image: ghcr.io/quantecon/${{ matrix.container }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
    
    name: html Â· ${{ matrix.repo.repo }} (${{ matrix.container }})
    
    steps:
      - name: Checkout actions repository
        uses: actions/checkout@v4
        with:
          path: actions-repo
      
      - name: Checkout lecture repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.owner }}/${{ matrix.repo.repo }}
          path: lecture-repo
      
      - name: Setup Environment
        uses: ./actions-repo/setup-environment
      
      - name: Build HTML (Execute Notebooks)
        uses: ./actions-repo/build-lectures
        with:
          source-dir: lecture-repo/lectures
          output-dir: lecture-repo
          builder: html
          upload-failure-reports: true
          failure-artifact-name: execution-reports-html-${{ matrix.container }}-${{ matrix.repo.repo }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.container }}-${{ matrix.repo.repo }}
          path: lecture-repo/lectures/_build
          retention-days: 1
