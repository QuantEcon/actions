name: Test Containers with Lectures

# Validates containers by running full lecture builds against all QuantEcon lecture repositories.
# This tests whether the container's built-in environment has all required dependencies.
# 
# NOTE: This workflow ignores each lecture repo's environment.yml and uses only the
# container's pre-installed packages. This validates the container is self-sufficient.
# 
# Runs after container builds complete (informational, not blocking).
# Can also be triggered manually for testing.

on:
  workflow_run:
    workflows: ["Build QuantEcon Containers"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      container:
        description: 'Container to test (or "all" to test all containers)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - quantecon-build
          - quantecon
      repos:
        description: 'Repositories to test (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string

# Define available containers in one place for easy maintenance
# To add a new container (e.g., GPU): add it to this list
env:
  ALL_CONTAINERS: '["quantecon-build","quantecon"]'
  ALL_REPOS: '["lecture-python-programming.myst","lecture-python-intro","lecture-python-advanced.myst","lecture-python.myst"]'

jobs:
  # Determine which containers and repos to test
  setup:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          # Determine containers to test
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.container }}" != "all" ]; then
            CONTAINERS='["${{ inputs.container }}"]'
          else
            # Test all containers for automated runs or when "all" selected
            CONTAINERS='${{ env.ALL_CONTAINERS }}'
          fi
          
          # Determine repos to test
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.repos }}" != "all" ]; then
            # Parse comma-separated repos
            REPOS='${{ inputs.repos }}'
            REPOS_JSON=$(echo "$REPOS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          else
            # Test all lecture repositories
            REPOS_JSON='${{ env.ALL_REPOS }}'
          fi
          
          # Create combined matrix
          echo "matrix={\"container\":$CONTAINERS,\"repo\":$REPOS_JSON}" >> $GITHUB_OUTPUT
          echo "Matrix: {\"container\":$CONTAINERS,\"repo\":$REPOS_JSON}"

  test-lectures:
    name: Test ${{ matrix.repo }} (${{ matrix.container }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    container:
      image: ghcr.io/quantecon/${{ matrix.container }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    strategy:
      fail-fast: false  # Continue testing other combinations even if one fails
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Display test info
        run: |
          echo "=========================================="
          echo "Testing: ${{ matrix.repo }}"
          echo "Container: ${{ matrix.container }}"
          echo "=========================================="
          cat /etc/quantecon-container || echo "Container marker not found"

      - name: Checkout lecture repository
        uses: actions/checkout@v4
        with:
          repository: QuantEcon/${{ matrix.repo }}

      - name: Display repository info
        run: |
          echo "Repository contents:"
          ls -la
          echo ""
          echo "Lectures directory:"
          ls -la lectures/ || echo "No lectures/ directory"
          echo ""
          echo "Environment file:"
          cat environment.yml || echo "No environment.yml"

      - name: Show container environment
        shell: bash
        run: |
          echo "Using container's built-in environment (ignoring lecture repo's environment.yml)"
          echo "This tests whether the container has all required dependencies pre-installed."
          echo ""
          source /opt/conda/etc/profile.d/conda.sh
          conda activate quantecon
          
          # Show key packages from container
          echo "Key packages in container:"
          conda list | grep -E "^(jupyter-book|quantecon|numpy|scipy|pandas|matplotlib|jax)" || true
          echo ""
          echo "Python version:"
          python --version

      - name: Build lectures (full execution)
        id: build
        shell: bash
        run: |
          echo "Starting full lecture build with execution..."
          echo "This may take 10-30+ minutes depending on the lecture series."
          echo ""
          
          source /opt/conda/etc/profile.d/conda.sh
          conda activate quantecon
          
          cd lectures
          
          # Record start time
          START_TIME=$(date +%s)
          
          # Build with strict mode and execution
          # -n: nitpicky mode (warn about all missing references)
          # -W: turn warnings into errors
          # --keep-going: continue building even if there are warnings
          jb build . --builder html -n -W --keep-going 2>&1 | tee ../build.log
          BUILD_STATUS=${PIPESTATUS[0]}
          
          # Record end time
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          echo ""
          echo "=========================================="
          echo "Build completed in ${MINUTES}m ${SECONDS}s"
          echo "Exit status: $BUILD_STATUS"
          echo "=========================================="
          
          # Set output for summary
          echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT
          echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          
          exit $BUILD_STATUS

      - name: Check build output
        if: always()
        run: |
          echo "Build artifacts:"
          ls -la lectures/_build/ 2>/dev/null || echo "No _build directory"
          
          if [ -d "lectures/_build/html" ]; then
            echo ""
            echo "HTML output:"
            ls -la lectures/_build/html/ | head -20
            
            echo ""
            echo "Total HTML files:"
            find lectures/_build/html -name "*.html" | wc -l
          fi
          
          if [ -f "lectures/_build/html/reports/index.html" ]; then
            echo ""
            echo "Execution reports available"
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.container }}-${{ matrix.repo }}
          path: |
            lectures/_build/html/
            build.log
          retention-days: 7

      - name: Upload execution reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.container }}-${{ matrix.repo }}
          path: |
            lectures/_build/html/reports/
          retention-days: 14

  # Summary job that runs after all tests complete
  summary:
    name: Test Summary
    needs: [setup, test-lectures]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Lecture Validation Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests run for each combination of container Ã— repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Containers tested:** \`${{ env.ALL_CONTAINERS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repositories tested:** \`${{ env.ALL_REPOS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job results above for detailed status of each container/repository combination." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts are named: \`build-{container}-{repo}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts retained for 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- Failure reports retained for 14 days" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: ${{ needs.test-lectures.result == 'failure' }}
        run: |
          echo "::warning::One or more lecture builds failed. Check artifacts for details."
          echo ""
          echo "This is informational - container has been published but may have issues"
          echo "with specific lecture repositories."
