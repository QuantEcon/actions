name: Test Container Builds

# Validates containers by building all lecture repos with all builders.
# Architecture: Each job builds one repo × one container through the full
# builder pipeline (html → pdflatex → jupyter) sequentially.
#
# Concurrency groups ensure the same repo never builds on two containers
# simultaneously, avoiding network contention from concurrent dataset
# downloads. Different repos can run in parallel.

on:
  workflow_run:
    workflows: ["Build QuantEcon Containers"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 120

    # Serialize containers for the same repo to avoid concurrent downloads
    concurrency:
      group: test-build-${{ matrix.repo.repo }}
      cancel-in-progress: false

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        container: [quantecon, quantecon-build]
        repo:
          - repo: lecture-python-intro
            owner: QuantEcon
          - repo: lecture-python.myst
            owner: QuantEcon
          - repo: lecture-python-advanced.myst
            owner: QuantEcon
          - repo: lecture-jax
            owner: QuantEcon

    container:
      image: ghcr.io/quantecon/${{ matrix.container }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root

    name: ${{ matrix.repo.repo }} · ${{ matrix.container }}

    steps:
      - name: Checkout actions repository
        uses: actions/checkout@v4
        with:
          path: actions-repo

      - name: Checkout lecture repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.owner }}/${{ matrix.repo.repo }}
          path: lecture-repo

      - name: Setup Environment
        uses: ./actions-repo/setup-environment

      # Stage 1: HTML (executes notebooks)
      - name: Build HTML (Execute Notebooks)
        uses: ./actions-repo/build-lectures
        with:
          source-dir: lecture-repo/lectures
          output-dir: lecture-repo
          builder: html
          upload-failure-reports: true
          failure-artifact-name: reports-html-${{ matrix.container }}-${{ matrix.repo.repo }}

      # Stage 2: pdflatex (reuses cached notebooks from HTML build)
      - name: Build PDF (No Execution)
        uses: ./actions-repo/build-lectures
        with:
          source-dir: lecture-repo/lectures
          output-dir: lecture-repo
          builder: pdflatex
          upload-failure-reports: true
          failure-artifact-name: reports-pdflatex-${{ matrix.container }}-${{ matrix.repo.repo }}

      # Stage 3: jupyter (reuses cached notebooks from HTML build)
      - name: Build Jupyter Notebooks (No Execution)
        uses: ./actions-repo/build-lectures
        with:
          source-dir: lecture-repo/lectures
          output-dir: lecture-repo
          builder: jupyter
          upload-failure-reports: true
          failure-artifact-name: reports-jupyter-${{ matrix.container }}-${{ matrix.repo.repo }}

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.container }}-${{ matrix.repo.repo }}
          path: lecture-repo/_build
          retention-days: 3
