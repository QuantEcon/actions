name: Test jupyter Builder (MyST to Notebook Conversion)

on:
  workflow_run:
    workflows: ["Test pdflatex Builder (PDF Rendering)"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test-jupyter:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        container: [quantecon, quantecon-build]
        repo:
          - repo: lecture-python-intro
            owner: QuantEcon
          - repo: lecture-python.myst
            owner: QuantEcon
          - repo: lecture-python-advanced.myst
            owner: QuantEcon
          - repo: lecture-jax
            owner: QuantEcon
    
    container:
      image: ghcr.io/quantecon/${{ matrix.container }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
    
    name: jupyter Â· ${{ matrix.repo.repo }} (${{ matrix.container }})
    
    steps:
      - name: Checkout actions repository
        uses: actions/checkout@v4
        with:
          path: actions-repo
      
      - name: Checkout lecture repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.owner }}/${{ matrix.repo.repo }}
          path: lecture-repo
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.container }}-${{ matrix.repo.repo }}
          path: lecture-repo/lectures/_build
      
      - name: Setup Environment
        uses: ./actions-repo/setup-environment
      
      - name: Build Jupyter Notebooks (No Execution)
        uses: ./actions-repo/build-lectures
        with:
          source-dir: lecture-repo/lectures
          output-dir: lecture-repo
          builder: jupyter
          upload-failure-reports: true
          failure-artifact-name: execution-reports-jupyter-${{ matrix.container }}-${{ matrix.repo.repo }}
