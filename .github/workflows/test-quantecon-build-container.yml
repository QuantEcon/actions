name: Test quantecon-build Container

# Validates quantecon-build container by building all lecture repos with all builders.
# Runs after container builds complete or can be triggered manually.

on:
  workflow_run:
    workflows: ["Build QuantEcon Containers"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      repos:
        description: 'Repositories to test (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string
      builder:
        description: 'Builder to test (or "all" to test all builders)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - html
          - pdflatex
          - jupyter

env:
  ALL_REPOS: '["lecture-python-programming.myst","lecture-python-intro","lecture-python-advanced.myst","lecture-python.myst"]'
  ALL_BUILDERS: '["html","pdflatex","jupyter"]'

jobs:
  setup:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          # Determine repos to test
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.repos }}" != "all" ]; then
            REPOS='${{ inputs.repos }}'
            REPOS_JSON=$(echo "$REPOS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          else
            REPOS_JSON='${{ env.ALL_REPOS }}'
          fi
          
          # Determine builders to test
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.builder }}" != "all" ]; then
            BUILDERS='["${{ inputs.builder }}"]'
          else
            BUILDERS='${{ env.ALL_BUILDERS }}'
          fi
          
          # Create combined matrix
          echo "matrix={\"repo\":$REPOS_JSON,\"builder\":$BUILDERS}" >> $GITHUB_OUTPUT
          echo "Matrix: {\"repo\":$REPOS_JSON,\"builder\":$BUILDERS}"

  test-lectures:
    name: ${{ matrix.builder }} · ${{ matrix.repo }}
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    container:
      image: ghcr.io/quantecon/quantecon-build:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    strategy:
      fail-fast: false
      max-parallel: 6  # Limit parallel jobs to reduce external load
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Display test info
        run: |
          echo "=========================================="
          echo "Container: quantecon-build"
          echo "Repo: ${{ matrix.repo }}"
          echo "Builder: ${{ matrix.builder }}"
          echo "=========================================="
          cat /etc/quantecon-container || echo "Container marker not found"

      - name: Checkout lecture repository
        uses: actions/checkout@v4
        with:
          repository: QuantEcon/${{ matrix.repo }}

      - name: Show container environment
        shell: bash
        run: |
          echo "Using container's built-in environment"
          source /opt/conda/etc/profile.d/conda.sh
          conda activate quantecon
          echo "Python version: $(python --version)"
          echo "Jupyter Book version: $(jupyter-book --version)"

      - name: Build lectures (${{ matrix.builder }})
        id: build
        shell: bash
        run: |
          source /opt/conda/etc/profile.d/conda.sh
          conda activate quantecon
          cd lectures
          
          START_TIME=$(date +%s)
          
          # Set builder command based on type
          if [ "${{ matrix.builder }}" = "html" ]; then
            jb build . --builder html -n -W --keep-going 2>&1 | tee ../build.log
          elif [ "${{ matrix.builder }}" = "pdflatex" ]; then
            jb build . --builder pdflatex -n -W --keep-going 2>&1 | tee ../build.log
          elif [ "${{ matrix.builder }}" = "jupyter" ]; then
            jb build . --builder=custom --custom-builder=jupyter -n -W --keep-going 2>&1 | tee ../build.log
          fi
          BUILD_STATUS=${PIPESTATUS[0]}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "=========================================="
          echo "Build completed in $((DURATION / 60))m $((DURATION % 60))s"
          echo "Exit status: $BUILD_STATUS"
          echo "=========================================="
          
          echo "duration=$((DURATION / 60))m $((DURATION % 60))s" >> $GITHUB_OUTPUT
          exit $BUILD_STATUS

      - name: Check build output
        if: always()
        run: |
          echo "Build artifacts:"
          ls -la lectures/_build/ 2>/dev/null || echo "No _build directory"
          
          if [ "${{ matrix.builder }}" = "html" ] && [ -d "lectures/_build/html" ]; then
            echo "Total HTML files: $(find lectures/_build/html -name '*.html' | wc -l)"
          elif [ "${{ matrix.builder }}" = "pdflatex" ] && [ -d "lectures/_build/latex" ]; then
            find lectures/_build/latex -name "*.pdf" -exec ls -lh {} \; || echo "No PDFs found"
          elif [ "${{ matrix.builder }}" = "jupyter" ] && [ -d "lectures/_build/jupyter" ]; then
            echo "Total notebooks: $(find lectures/_build/jupyter -name '*.ipynb' | wc -l)"
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.builder }}-quantecon-build-${{ matrix.repo }}
          path: |
            lectures/_build/
            build.log
          retention-days: 7

      - name: Upload execution reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.builder }}-quantecon-build-${{ matrix.repo }}
          path: |
            lectures/_build/html/reports/
          retention-days: 14

  summary:
    name: Test Summary
    needs: [setup, test-lectures]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# quantecon-build Container Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** \`quantecon-build\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`ghcr.io/quantecon/quantecon-build:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests run for each combination of repository × builder." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repositories:** \`${{ env.ALL_REPOS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Builders:** \`${{ env.ALL_BUILDERS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Total combinations:** 12 (4 repos × 3 builders)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ Parallel limit: 6 jobs at a time (reduces load on external services)" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: ${{ needs.test-lectures.result == 'failure' }}
        run: |
          echo "::warning::One or more lecture builds failed. Check artifacts for details."
