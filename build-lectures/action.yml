name: 'Build Lectures'
description: 'Builds QuantEcon lectures using Jupyter Book with execution caching'
author: 'QuantEcon'

inputs:
  builder:
    description: 'Jupyter Book builder to use (html, pdflatex, custom --custom-builder=jupyter)'
    required: false
    default: 'html'
  source-dir:
    description: 'Source directory containing lectures'
    required: false
    default: 'lectures'
  output-dir:
    description: 'Output directory for build artifacts'
    required: false
    default: './'
  extra-args:
    description: 'Extra arguments to pass to jupyter-book build'
    required: false
    default: '-W --keep-going'
  cache-notebook-execution:
    description: 'Enable notebook execution caching'
    required: false
    default: 'true'
  use-build-cache:
    description: 'Restore _build directory from GitHub cache before building (for fast incremental PR builds)'
    required: false
    default: 'false'
  html-copy-pdf:
    description: 'Copy PDF from _build/latex/ to _build/html/_pdf/ (HTML builder only, requires prior pdflatex build)'
    required: false
    default: 'false'
  html-copy-notebooks:
    description: 'Copy notebooks from _build/jupyter/ to _build/html/_notebooks/ (HTML builder only, requires prior jupyter build)'
    required: false
    default: 'false'
  upload-failure-reports:
    description: 'Upload execution reports as artifacts when build fails'
    required: false
    default: 'false'

outputs:
  build-path:
    description: 'Path to the build output directory'
    value: ${{ steps.build.outputs.build-path }}
  build-cache-hit:
    description: 'Whether the build cache was restored'
    value: ${{ steps.build-cache.outputs.cache-hit }}

runs:
  using: "composite"
  steps:
    - name: Restore build cache
      if: inputs.use-build-cache == 'true'
      uses: actions/cache/restore@v4
      id: build-cache
      with:
        path: _build
        key: build-${{ hashFiles('environment.yml') }}
        restore-keys: |
          build-

    - name: Cache Jupyter execution
      if: inputs.cache-notebook-execution == 'true' && inputs.use-build-cache != 'true'
      uses: actions/cache@v4
      id: jupyter-cache
      with:
        path: |
          _build/.jupyter_cache
        key: jupyter-cache-${{ runner.os }}-${{ hashFiles('lectures/**/*.md') }}-${{ github.sha }}
        restore-keys: |
          jupyter-cache-${{ runner.os }}-${{ hashFiles('lectures/**/*.md') }}-
          jupyter-cache-${{ runner.os }}-

    - name: Build lectures
      id: build
      shell: bash -l {0}
      run: |
        echo "Building with builder: ${{ inputs.builder }}"
        
        # Set build command based on builder type
        if [ "${{ inputs.builder }}" = "html" ]; then
          BUILD_CMD="jb build ${{ inputs.source-dir }} --path-output ${{ inputs.output-dir }} ${{ inputs.extra-args }}"
        elif [ "${{ inputs.builder }}" = "pdflatex" ]; then
          BUILD_CMD="jb build ${{ inputs.source-dir }} --builder pdflatex --path-output ${{ inputs.output-dir }} -n ${{ inputs.extra-args }}"
        elif [ "${{ inputs.builder }}" = "jupyter" ]; then
          BUILD_CMD="jb build ${{ inputs.source-dir }} --path-output ${{ inputs.output-dir }} --builder=custom --custom-builder=jupyter -n ${{ inputs.extra-args }}"
        else
          # Custom builder
          BUILD_CMD="jb build ${{ inputs.source-dir }} --builder ${{ inputs.builder }} --path-output ${{ inputs.output-dir }} ${{ inputs.extra-args }}"
        fi
        
        echo "::group::Build Command"
        echo "$BUILD_CMD"
        echo "::endgroup::"
        
        # Execute build and capture exit code
        set +e
        eval $BUILD_CMD
        BUILD_EXIT_CODE=$?
        set -e
        
        # Set output paths regardless of success/failure
        if [ "${{ inputs.builder }}" = "html" ]; then
          echo "build-path=${{ inputs.output-dir }}/_build/html" >> $GITHUB_OUTPUT
        elif [ "${{ inputs.builder }}" = "pdflatex" ]; then
          echo "build-path=${{ inputs.output-dir }}/_build/latex" >> $GITHUB_OUTPUT
        elif [ "${{ inputs.builder }}" = "jupyter" ]; then
          echo "build-path=${{ inputs.output-dir }}/_build/jupyter" >> $GITHUB_OUTPUT
        else
          echo "build-path=${{ inputs.output-dir }}/_build" >> $GITHUB_OUTPUT
        fi
        
        # Exit with build exit code
        exit $BUILD_EXIT_CODE

    - name: Copy PDF to HTML
      if: inputs.builder == 'html' && inputs.html-copy-pdf == 'true' && success()
      shell: bash
      run: |
        echo "::group::Copy PDF to HTML"
        PDF_SOURCE="${{ inputs.output-dir }}/_build/latex"
        PDF_DEST="${{ inputs.output-dir }}/_build/html/_pdf"
        
        if [ -d "$PDF_SOURCE" ]; then
          mkdir -p "$PDF_DEST"
          # Copy all PDFs
          find "$PDF_SOURCE" -name "*.pdf" -exec cp {} "$PDF_DEST/" \;
          echo "Copied PDFs to $PDF_DEST:"
          ls -lh "$PDF_DEST" || echo "No PDFs found"
        else
          echo "::warning::PDF source directory not found: $PDF_SOURCE"
          echo "Run pdflatex builder before html builder with html-copy-pdf"
        fi
        echo "::endgroup::"

    - name: Copy notebooks to HTML
      if: inputs.builder == 'html' && inputs.html-copy-notebooks == 'true' && success()
      shell: bash
      run: |
        echo "::group::Copy Notebooks to HTML"
        NB_SOURCE="${{ inputs.output-dir }}/_build/jupyter"
        NB_DEST="${{ inputs.output-dir }}/_build/html/_notebooks"
        
        if [ -d "$NB_SOURCE" ]; then
          mkdir -p "$NB_DEST"
          # Copy all notebooks to flat directory
          find "$NB_SOURCE" -name "*.ipynb" -exec cp {} "$NB_DEST/" \;
          echo "Copied notebooks to $NB_DEST:"
          ls -lh "$NB_DEST" | head -20 || echo "No notebooks found"
          NB_COUNT=$(find "$NB_DEST" -name "*.ipynb" | wc -l)
          echo "Total notebooks: $NB_COUNT"
        else
          echo "::warning::Notebook source directory not found: $NB_SOURCE"
          echo "Run jupyter builder before html builder with html-copy-notebooks"
        fi
        echo "::endgroup::"

    - name: Report build failure
      if: failure()
      shell: bash
      run: |
        echo ""
        echo "::error::âŒ BUILD FAILED - Jupyter Book build encountered errors"
        echo ""
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚                    BUILD FAILURE SUMMARY                      â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚  Builder:     ${{ inputs.builder }}"
        echo "â”‚  Source:      ${{ inputs.source-dir }}"
        echo "â”‚  Output:      ${{ inputs.output-dir }}/_build"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        echo ""
        if [ "${{ inputs.upload-failure-reports }}" = "true" ]; then
          echo "ğŸ“¦ Execution reports will be uploaded as artifact: execution-reports-${{ inputs.builder }}"
          echo ""
          echo "To debug this failure:"
          echo "  1. Download the 'execution-reports-${{ inputs.builder }}' artifact from this workflow run"
          echo "  2. Check _build/${{ inputs.builder }}/reports/ for notebook execution logs"
          echo "  3. Check _build/.jupyter_cache/ for cached notebook states"
          echo ""
        else
          echo "ğŸ’¡ Tip: Enable 'upload-failure-reports: true' to get execution reports for debugging"
          echo ""
        fi

    - name: Upload execution reports on failure
      if: inputs.upload-failure-reports == 'true' && failure()
      uses: actions/upload-artifact@v4
      with:
        name: execution-reports-${{ inputs.builder }}
        path: |
          ${{ inputs.output-dir }}/_build/html/reports
          ${{ inputs.output-dir }}/_build/latex/reports
          ${{ inputs.output-dir }}/_build/jupyter/reports
          ${{ inputs.output-dir }}/_build/.jupyter_cache
        if-no-files-found: ignore
        retention-days: 7

    - name: Display Build Info
      if: success()
      shell: bash
      run: |
        echo "::group::Build Summary"
        echo "Builder: ${{ inputs.builder }}"
        echo "Source: ${{ inputs.source-dir }}"
        echo "Output: ${{ steps.build.outputs.build-path }}"
        echo "Build cache hit: ${{ steps.build-cache.outputs.cache-hit || 'N/A' }}"
        echo "Jupyter cache hit: ${{ steps.jupyter-cache.outputs.cache-hit || 'N/A' }}"
        if [ "${{ inputs.builder }}" = "html" ]; then
          echo "PDF copied to HTML: ${{ inputs.html-copy-pdf }}"
          echo "Notebooks copied to HTML: ${{ inputs.html-copy-notebooks }}"
        fi
        echo "::endgroup::"
        
        echo "::group::Build Artifacts"
        ls -lh ${{ steps.build.outputs.build-path }} || echo "Build directory not found"
        echo "::endgroup::"

branding:
  icon: 'book-open'
  color: 'purple'
